stages:
  - npm
  - docker
  - deploy

variables:
  NEXUS_IMAGE_TAG: $NEXUS_REGISTRY/crs:latest
  RPC_PROVIDER_URL: $RPC_PROVIDER_URL

build-npm:
  stage: npm
  image: node:lts
  script:
    - npm ci
    - npm run build
    - npm publish
  rules:
    - if: $CI_COMMIT_TAG != null

build-docker:
  stage: docker
  image: docker
  services:
      - name: docker:dind
        entrypoint: ["sh", "-c", "dockerd-entrypoint.sh --insecure-registry=$NEXUS_REGISTRY"]
  before_script:
    - docker login $NEXUS_REGISTRY -u $NEXUS_USER -p $NEXUS_PASSWORD
  script:
    - docker build -t $NEXUS_IMAGE_TAG .
    - docker push $NEXUS_IMAGE_TAG
  after_script:
    - docker logout $NEXUS_REGISTRY
  rules:
    - if: $CI_COMMIT_TAG != null

deploy:
  stage: deploy
  script:
    - 'curl --request POST --header "Authorization: Bearer $ANSIBLE_DEPLOY_TOKEN" "$URL_DEPLOY_CRS"'
  rules:
    - if: $CI_COMMIT_TAG != null
    
